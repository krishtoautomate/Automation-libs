/*
 * This file was generated by the Gradle 'init' task.
 *
 * This generated file contains a sample Java Library project to get you started.
 * For more details take a look at the Java Libraries chapter in the Gradle
 * User Manual available at https://docs.gradle.org/5.4.1/userguide/java_library_plugin.html
 */

plugins {
    id 'java'
    id 'maven-publish'
    id 'groovy'
}

def timestamp() {
    return new Date().format('yyyy-MM-dd')
}

repositories {
	mavenCentral()
//            {
//        System.setProperty('http.proxyHost', 'fastweb.int.bell.ca')
//        System.setProperty('http.proxyPort', '8083')
//        System.setProperty('https.proxyHost', 'fastweb.int.bell.ca')
//        System.setProperty('https.proxyPort', '8083')
//    }
    mavenLocal()
    google()
}
dependencies {

    implementation fileTree(dir: 'libs', include: ['*.jar'])
    testImplementation files('libs/webdrivermanager.jar')

    testImplementation 'org.assertj:assertj-core:2.0.0'

    testImplementation 'org.seleniumhq.selenium:selenium-java:4.7.0'
    testImplementation 'org.seleniumhq.selenium:selenium-support:4.7.0'

    testImplementation 'io.appium:java-client:8.3.0'
    
    testImplementation 'io.cucumber:cucumber-java:7.3.1'
    testImplementation 'io.cucumber:cucumber-testng:7.3.1'
    testImplementation 'io.cucumber:cucumber-junit:7.2.3'

    testImplementation 'commons-io:commons-io:2.6'
    testImplementation 'com.google.code.gson:gson:2.8.6'
    implementation 'com.googlecode.json-simple:json-simple:1.1.1'

    implementation 'javax.mail:mail:1.4'
    implementation 'org.json:json:20160810'
    implementation 'com.opencsv:opencsv:4.0'
    implementation 'com.jcraft:jsch:0.1.54'
    implementation 'org.bytedeco.javacpp-presets:tesseract:4.0.0-1.4.4'
    
    testImplementation 'io.rest-assured:rest-assured:4.4.0'
   
   	testImplementation 'com.aventstack:extentreports:5.0.8'
   	testImplementation 'tech.grasshopper:pdfextentreporter:0.3'

    testImplementation 'com.google.guava:guava:21.0'


    implementation 'org.apache.logging.log4j:log4j-core:2.13.3'
    implementation 'org.apache.logging.log4j:log4j-api:2.13.3'
    implementation 'log4j:log4j:1.2.17'
    implementation 'org.slf4j:slf4j-api:2.0.5'
    implementation 'org.slf4j:slf4j-jdk14:2.0.5'
	
    testImplementation "com.oracle.ojdbc:ojdbc8:19.3.0.0"
    
    testImplementation 'com.slack.api:slack-api-client:1.8.1'
    testImplementation 'org.testng:testng:7.1.0'

    // https://mvnrepository.com/artifact/org.seleniumhq.selenium/selenium-server
//    implementation 'org.seleniumhq.selenium:selenium-server:3.141.59'

}

group = 'Automation-libs'
version = '0.0.1-SNAPSHOT'
sourceCompatibility = '11'

publishing {
    publications {
        maven(MavenPublication) {
            from(components.java)
        }
    }
}

tasks.withType(JavaCompile) {
    options.encoding = 'UTF-8'
    
    gradle.projectsEvaluated {
        tasks.withType(JavaCompile) {
            options.compilerArgs << "-Xlint:unchecked"
        }
    }
}

task cucumber() {
    dependsOn assemble, testClasses
    doLast {
        javaexec {
            main = "io.cucumber.core.cli.Main"
            classpath = configurations.cucumberRuntime + sourceSets.main.output + sourceSets.test.output
            args = ['--plugin', 'pretty', '--glue', 'gradle.cucumber', 'src/test/resources']
        }
    }
}

//./gradlew BaseJar
task BaseJar(type: Jar) {
    from sourceSets.test.output
    include 'com/base/*'
    include 'com/ReportManager/*'
    include 'com/DataManager/*'
    include 'com/Drivers/*'
    destinationDirectory = file("$buildDir/jar")
    archiveName = 'Base.jar'
    exclude 'META-INF/MANIFEST.MF'
}

//grid-capability-matcher-3.141.59.jar
//./gradlew GridJar
task GridJar(type: Jar) {
    from sourceSets.main.output
    include 'com/selenium/grid/matcher/*'
    destinationDirectory = file("$buildDir/jar")
    archiveName = 'grid-capability-matcher-3.141.59.jar'
    exclude 'META-INF/MANIFEST.MF'
}


//gradle clean compiletestjava -PappPackage=BETA -PappActivity=activity -PbundleId=PROD
//task createCapability(type: Exec) {
//tasks.create(name: 'createCapability') {
/*
    File capabilities = new File(projectDir, "capabilities.json"); //.mkdirs();
    capabilities.write('{\n'+
					'"ANDROID":\n'+
					  '[\n'+
					    '{\n'+
						    '"platformName": "Android",\n'+
						    '"platformVersion":"8.1.0",\n'+
						    '"automationName":"uiautomator2",\n'+
						    '"autoLaunch":true,\n'+
							'"noReset":true,\n'+
							'"fullReset":false,\n'+
							'"newCommandTimeout":60,\n'+
							'"androidInstallTimeout":150000,\n'+
							'"autoDismissAlerts":true,\n'+
						    '"appPackage":"'+findProperty('appPackage')+'",\n'+
						    '"appActivity":"'+findProperty('appActivity')+'"\n'+
						'}\n'+
					  '],\n'+
				'"IOS":\n'+
				      '[\n'+
				        '{\n'+
						    '"platformName": "iOS",\n'+
						    '"platformVersion": "12.2",\n'+
						    '"automationName": "XCUITest",\n'+
						    '"autoLaunch":true,\n'+
						    '"fullReset":false,\n'+
						    '"noReset":false,\n'+
						    '"useNewWDA":true,\n'+
							'"newCommandTimeout":60,\n'+
							'"useJSONSource":true,\n'+
							'"autoDismissAlerts":true,\n'+
						    '"bundleId":"'+findProperty('bundleId')+'",\n'+
						    '"waitForQuiescence":false,\n'+
						    '"wdaStartupRetries":5,\n'+
						    '"wdaStartupRetryInterval":1000\n'+
						'}\n'+
				      ']\n'+
				'}');
}
*/
allprojects { project ->
    tasks.withType(Test) { testTask ->
        afterSuite { desc, result ->
            if (!desc.parent) { // will match the outermost suite
                def output = "Results: ${result.resultType} (${result.testCount} tests, ${result.successfulTestCount} Passed, ${result.failedTestCount} Failures, ${result.skippedTestCount} Skipped)"
                def startItem = '|  ', endItem = '  |'
                def repeatLength = startItem.length() + output.length() + endItem.length()
                println('\n' + ('-' * repeatLength) + '\n' + startItem + output + endItem + '\n' + ('-' * repeatLength))
            }
            //println("Failed Test Count : " + result.failedTestCount)
            if (result.failedTestCount < result.successfulTestCount) {
                ignoreFailures = true

                println("failedTestCount : " + result.failedTestCount)
            }else{
                ignoreFailures = false

                println("failedTestCount : " + result.failedTestCount)
            }
        }
    }
}

test {
	testLogging {
		events "passed", "skipped", "failed"
	}

	testLogging.showStandardStreams = true
	
    useTestNG(){
    
        if (project.hasProperty('testNG')) { 
        	suites 'src/test/resources/debugTestNG.xml' 
        }
         suites ''+System.getProperty('testNGsuiteXmlFile')
        //suites 'src/test/resources/'+System.getProperty('testNGsuiteXmlFile')
        //implimentation : gradle clean test -DtestNGsuiteXmlFile=src/test/resources/debugTestNG.xml
        
	    useDefaultListeners = true
    }
    ext.workingDirectory = 'test-output/${timestamp()}'
    
}
